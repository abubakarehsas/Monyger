package com.asisdroid.moneymanager;

import android.app.DatePickerDialog;
import android.content.SharedPreferences;
import android.graphics.Color;
import android.graphics.Typeface;
import android.graphics.drawable.Drawable;
import android.net.Uri;
import android.os.Bundle;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentTransaction;
import android.support.v7.widget.Toolbar;
import android.text.SpannableString;
import android.text.style.ForegroundColorSpan;
import android.text.style.RelativeSizeSpan;
import android.text.style.StyleSpan;
import android.util.Log;
import android.view.View;
import android.view.Menu;
import android.view.MenuItem;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.DatePicker;
import android.widget.ExpandableListView;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.RelativeLayout;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import com.asisdroid.moneymanager.Dialog.DialogDatepickerFragment;
import com.asisdroid.moneymanager.database.ExpenseAccountDBAdapter;
import com.asisdroid.moneymanager.database.IncomeAccountDBAdapter;
import com.asisdroid.moneymanager.utility.FontUtils;
import com.asisdroid.moneymanager.utility.MMUtils;
import com.asisdroid.moneymanager.utility.MoneyManagerPreferences;
import com.github.mikephil.charting.animation.Easing;
import com.github.mikephil.charting.charts.HorizontalBarChart;
import com.github.mikephil.charting.charts.PieChart;
import com.github.mikephil.charting.data.Entry;
import com.github.mikephil.charting.data.PieData;
import com.github.mikephil.charting.data.PieDataSet;
import com.github.mikephil.charting.data.PieEntry;
import com.github.mikephil.charting.formatter.PercentFormatter;
import com.github.mikephil.charting.highlight.Highlight;
import com.github.mikephil.charting.listener.OnChartValueSelectedListener;
import com.github.mikephil.charting.utils.ColorTemplate;
import com.github.mikephil.charting.utils.MPPointF;
import com.sothree.slidinguppanel.SlidingUpPanelLayout;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.List;

public class MainActivity extends DemoBase implements  OnChartValueSelectedListener, DatePickerDialog.OnDateSetListener, AddAccFragment.OnFragmentInteractionListener {

    private static final String SLIDINGTAG = "AndroidSlidingUpPanel";

    private TextView txtCredit, txtDebit,txtCreditMin, txtDebitMin, txtDate, txtCalendar, txtDay, txtMonth, txtWeek, txtYear;
    private ImageView btnBalanceLeft, btnBalanceRight, connectorLeft, connectorRight;
    private TextView btnBalanceMid, expenseDetailsTabClick, incomeDetailsTabClick, expenseDetailsTabClickSelector,incomeDetailsTabClickSelector, noDataErrs;
    private FontUtils fontUtils;
    private PieChart mChart;
    private HorizontalBarChart mBarChart;
    private Toolbar toolbar;
    private static Calendar cal;
    private ImageView nextData, prevData;
    public static  MainActivity mainActivityInstance;
    private LinearLayout expenseDateLayout;
    private LinearLayout bottomLayout, bottomLayoutMin;
    private int mShortAnimationDuration;
    private RelativeLayout slidingBalanceLayout, mainLayout, subLayout;
    public static boolean isMenuVisibleOrNot = false;
    private Animation closeMenuAnime, openMenuAnime, fadeInAnime, sliderAnime;
    private boolean isNextBlocked = true;

    private Spinner sortingSpinner;

    private IncomeAccountDBAdapter incomeAccDb;
    private ExpenseAccountDBAdapter expenseAccDb;

    private int chartClickedCatgIndex = -1;

    private FragmentManager fragmentManager;
    private FragmentTransaction fragmentTransaction;
    public AddAccFragment myFragment;

    private String dataDateStart, dataDateEnd;

    private ArrayList<String> incomeDataArray, expenseDataArray,  dateOfTransIArray,shortNotesIArray, catgIArray,
             dateOfTransEArray,shortNotesEArray, paymentTypeEArray, catgEArray,catgChartArray, catgChartIArray;

    private ArrayList<Integer> amountIArray, amountEArray, amountChartArray;
    private int totalIncome = 0, totalExpense = 0;

    private HashMap<String, Integer> catgAllDrawableHashmap = new HashMap<>();

    ListViewCustomAdapter listAdapter;
    ExpandableListView listOfBalance;
    List<String> listDataHeader;
    HashMap<String, List<String>> listDataChild;

    private Menu mainMenu;

    private static final String currentViewPreference = "MyPrefs" ;
    private static final String currentView = "calndrView" ;
    private static final String DayView = "day" ;
    private static final String MonthView = "month" ;
    private static final String YearView = "year" ;
    private static final String DateView = "date" ;
    private static final String WeekView = "week" ;
    public SharedPreferences currentCalndrDisplay;

    private String currentDetailsView = "expense";
    private int currentSortingOption = 0;

     protected SlidingUpPanelLayout mLayout;

    private MoneyManagerPreferences myPreference;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        mainActivityInstance = this;
        myPreference = MoneyManagerPreferences.getInstance(mainActivityInstance);
        setContentView(R.layout.activity_main);
        toolbar = (Toolbar) findViewById(R.id.toolbar);

        //Setting Action bar string and style
        SpannableString s = new SpannableString("Money Manager");
        s.setSpan(new StyleSpan(Typeface.BOLD_ITALIC), 0, s.length(), 0);
        setSupportActionBar(toolbar);
        getSupportActionBar().setTitle(s);
        //getSupportActionBar().setIcon(R.mipmap.ic_launcher);

        //Calling all initializing functions
        initMyUI();
        getDbDatas();
        //initBarCharts();
        setFonts();
        setMyEvents();
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.menu_main, menu);
        mainMenu = menu;
        if(subLayout.getVisibility() == View.VISIBLE) {
            mainMenu.getItem(0).setVisible(false);
            mainMenu.getItem(1).setVisible(true);
        }
        else {
            mainMenu.getItem(1).setVisible(false);
            mainMenu.getItem(0).setVisible(true);
        }
        return true;
    }


    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {

            case R.id.moreoptions: {
                if(isMenuVisibleOrNot==true)
                {
                    closeTheExpenseDateMenu();
                }
                else
                {
                    isMenuVisibleOrNot = true;
                    if(openMenuAnime == null)
                    {openMenuAnime = AnimationUtils.loadAnimation(getApplicationContext(), R.anim.movedown);}
                    openMenuAnime.setFillAfter(true);
                    expenseDateLayout.startAnimation(openMenuAnime);
                    openMenuAnime.setAnimationListener(new Animation.AnimationListener() {
                        @Override
                        public void onAnimationStart(Animation animation) {
                            expenseDateLayout.setVisibility(View.VISIBLE);
                        }

                        @Override
                        public void onAnimationEnd(Animation animation) {
                        }

                        @Override
                        public void onAnimationRepeat(Animation animation) {
                        }
                    });

                    //Making the calendar options inactive if it is active
                    if(isActive(txtCalendar))
                    {
                        setInActive(txtCalendar);
                    }

                    openMenuAnime = null;
                }

                break;
            }
            case R.id.saveData : {
                //CALL HERE THE FRAGMENT FUNCTION
                if(myFragment!=null){
                    myFragment.onSaveAccData();
                }
                break;
            }
             /* case R.id.actionToggleIcons: {
                for (IDataSet<?> set : mChart.getData().getDataSets())
                    set.setDrawIcons(!set.isDrawIconsEnabled());

                mChart.invalidate();
                break;
            }
            case R.id.actionToggleHole: {
                if (mChart.isDrawHoleEnabled())
                    mChart.setDrawHoleEnabled(false);
                else
                    mChart.setDrawHoleEnabled(true);
                mChart.invalidate();
                break;
            }
            case R.id.actionDrawCenter: {
                if (mChart.isDrawCenterTextEnabled())
                    mChart.setDrawCenterText(false);
                else
                    mChart.setDrawCenterText(true);
                mChart.invalidate();
                break;
            }
            case R.id.actionToggleXVals: {

                mChart.setDrawEntryLabels(!mChart.isDrawEntryLabelsEnabled());
                mChart.invalidate();
                break;
            }
            case R.id.actionSave: {
                // mChart.saveToGallery("title"+System.currentTimeMillis());
                mChart.saveToPath("title" + System.currentTimeMillis(), "");
                break;
            }
            case R.id.actionTogglePercent:
                mChart.setUsePercentValues(!mChart.isUsePercentValuesEnabled());
                mChart.invalidate();
                break;
            case R.id.animateX: {
                mChart.animateX(1400);
                break;
            }
            case R.id.animateY: {
                mChart.animateY(1400);
                break;
            }
            case R.id.animateXY: {
                mChart.animateXY(1400, 1400);
                break;
            }
            case R.id.actionToggleSpin: {
                mChart.spin(1000, mChart.getRotationAngle(), mChart.getRotationAngle() + 360, Easing.EasingOption
                        .EaseInCubic);
                break;
            }*/
        }
        return true;
    }

    private void setData(int count, float range) {

        ArrayList<PieEntry> entries = new ArrayList<PieEntry>();
        float percentage;
        Drawable tempDrawable;
        int tempIndex;

        if(amountEArray.size()>0){
            for (int i = 0; i < amountEArray.size() ; i++) {
                tempIndex =catgChartArray.indexOf(catgEArray.get(i));
               if(tempIndex>=0){
                  amountChartArray.set(tempIndex,amountChartArray.get(tempIndex)+amountEArray.get(i));
               }
               else{
                   amountChartArray.add(amountEArray.get(i));
                   catgChartArray.add(catgEArray.get(i));
               }
            }
        }
        // NOTE: The order of the entries when being added to the entries array determines their position around the center of
        // the chart.
        if(amountChartArray.size()>0){
            for (int i = 0; i < amountChartArray.size() ; i++) {
                percentage = (((float)amountChartArray.get(i)/totalExpense)*100);
                try {
                    tempDrawable = getResources().getDrawable(catgAllDrawableHashmap.get(catgChartArray.get(i)));
                }
                catch (NullPointerException e){
                    tempDrawable = getResources().getDrawable(R.drawable.catg_custom);
                }
                entries.add(new PieEntry(percentage, catgChartArray.get(i),tempDrawable));
            }
        }
        else{
            entries.add(new PieEntry(100.0f,
                    "No records",
                    getResources().getDrawable(R.mipmap.norecords)));
        }

        PieDataSet dataSet = new PieDataSet(entries, "");
        dataSet.setDrawIcons(true);
        dataSet.setSliceSpace(3f);
        dataSet.setIconsOffset(new MPPointF(0, 40));
        dataSet.setSelectionShift(5f);

        // add a lot of colors
        ArrayList<Integer> colors = new ArrayList<Integer>();
        int[] COLORFUL_COLORS = {
                Color.rgb(193, 37, 82), Color.rgb(255, 102, 0), Color.rgb(245, 199, 0),
                Color.rgb(106, 150, 31), Color.rgb(179, 100, 53), Color.rgb(64, 89, 128), Color.rgb(149, 165, 124), Color.rgb(217, 184, 162),
                Color.rgb(191, 134, 134), Color.rgb(179, 48, 80)
        };
        for (int c : COLORFUL_COLORS)
            colors.add(c);

        colors.add(ColorTemplate.getHoloBlue());

        dataSet.setColors(colors);
        //dataSet.setSelectionShift(0f);

        PieData data = new PieData(dataSet);
        data.setValueFormatter(new PercentFormatter());
        data.setValueTextSize(11f);
        data.setValueTextColor(Color.BLACK);
        data.setValueTypeface(gothamBold);
        mChart.setData(data);

        // undo all highlights
        mChart.highlightValues(null);
        mChart.invalidate();

        //SETTING THE BALANCE
        btnBalanceMid.setText("Balance = ₹ "+(totalIncome-totalExpense));
        totalExpense = 0;
        totalIncome = 0;
        String [] your_array_list ={"custom","bill","rebt"};
        int [] prgmImages={R.drawable.catg_custom,R.drawable.catg_bill,R.drawable.catg_rental};

        // This is the array adapter, it takes the context of the activity as a
        // first parameter, the type of list view as a second parameter and your
        // array as a third parameter.
        //listOfBalance.setAdapter(new ListViewCustomAdapter(this, your_array_list,prgmImages));
        // preparing list data
        prepareListData();

          // Listview Group click listener
        listOfBalance.setOnGroupClickListener(new ExpandableListView.OnGroupClickListener() {

            @Override
            public boolean onGroupClick(ExpandableListView parent, View v,
                                        int groupPosition, long id) {
                // Toast.makeText(getApplicationContext(),
                // "Group Clicked " + listDataHeader.get(groupPosition),
                // Toast.LENGTH_SHORT).show();
                return false;
            }
        });

        // Listview Group expanded listener
        listOfBalance.setOnGroupExpandListener(new ExpandableListView.OnGroupExpandListener() {

            @Override
            public void onGroupExpand(int groupPosition) {
                /*Toast.makeText(getApplicationContext(),
                        listDataHeader.get(groupPosition) + " Expanded",
                        Toast.LENGTH_SHORT).show();*/
            }
        });

        // Listview Group collasped listener
        listOfBalance.setOnGroupCollapseListener(new ExpandableListView.OnGroupCollapseListener() {

            @Override
            public void onGroupCollapse(int groupPosition) {
               /* Toast.makeText(getApplicationContext(),
                        listDataHeader.get(groupPosition) + " Collapsed",
                        Toast.LENGTH_SHORT).show();*/

            }
        });

        // Listview on child click listener
        listOfBalance.setOnChildClickListener(new ExpandableListView.OnChildClickListener() {

            @Override
            public boolean onChildClick(ExpandableListView parent, View v,
                                        int groupPosition, int childPosition, long id) {
                // TODO Auto-generated method stub
                Toast.makeText(
                        getApplicationContext(),
                        listDataHeader.get(groupPosition)
                                + " : "
                                + listDataChild.get(
                                listDataHeader.get(groupPosition)).get(
                                childPosition), Toast.LENGTH_SHORT)
                        .show();
                return false;
            }
        });
    }

    private SpannableString generateCenterSpannableText() {
        SpannableString s = new SpannableString("Expense - ₹ "+totalExpense+"\nIncome - ₹ "+totalIncome);
        s.setSpan(new RelativeSizeSpan(1.7f), 0, 7, 0);
        int tempval = 11+(String.valueOf(totalExpense)).length() + 1;
        s.setSpan(new RelativeSizeSpan(1.7f), tempval, tempval+7, 0);
        s.setSpan(new StyleSpan(Typeface.ITALIC), s.length() - ((String.valueOf(totalIncome)).length()+4), s.length(), 0);
        s.setSpan(new StyleSpan(Typeface.ITALIC), 10, 10+(String.valueOf(totalExpense)).length()+2, 0);
        s.setSpan(new ForegroundColorSpan(getResources().getColor(R.color.colorPrimaryDark)), s.length() - ((String.valueOf(totalIncome)).length()+4), s.length(), 0);
        s.setSpan(new ForegroundColorSpan(getResources().getColor(R.color.colorPrimaryDark)), 10, 10+(String.valueOf(totalExpense)).length()+2, 0);
        return s;
    }

    @Override
    public void onValueSelected(Entry e, Highlight h) {
        if (e == null) return;
        if(catgEArray.size()>0) {
            currentDetailsView = "expense";
            expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
            incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
            expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
            incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
        }
        else if(catgIArray.size()>0){
            currentDetailsView = "income";
            expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
            incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
            expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
            incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
        }
            chartClickedCatgIndex = Math.round(h.getX()); //Setting the index of the selected chart
            mChart.spin(1000, mChart.getRotationAngle(), mChart.getRotationAngle() + 360, Easing.EasingOption.EaseInBounce);
            prepareListData();
            mLayout.setPanelState(SlidingUpPanelLayout.PanelState.EXPANDED);
        if(isMenuVisibleOrNot == true)
        {
            closeTheExpenseDateMenu();
            //Log.i("VAL SELECTED", "Value: " + e.getY() + ", index: " + h.getX() + ", DataSet index: " + h.getDataSetIndex());
        }
    }

    @Override
    public void onNothingSelected() {
        //Log.i("PieChart", "nothing selected");
    }

    public String getCurrentDateAndTime(int nextVal, boolean resetCalendar)
    {
        if(resetCalendar == true)
        {
            cal = Calendar.getInstance();
        }
        String mydate;
        SimpleDateFormat formater = new SimpleDateFormat("dd MMMM, EEEE");
        cal.add(Calendar.DATE, nextVal);
        return formater.format(cal.getTime());
    }

    public String getCurrentMonth(int nextVal, boolean resetCalendar)
    {
        if(resetCalendar == true)
        {
            cal = Calendar.getInstance();
        }
        String mydate;
        SimpleDateFormat formater = new SimpleDateFormat("MMMM yyyy");
        cal.add(Calendar.MONTH, nextVal);
        return formater.format(cal.getTime());
    }

    public String getCurrentYear(int nextVal, boolean resetCalendar)
    {
        if(resetCalendar == true)
        {
            cal = Calendar.getInstance();
        }
        String mydate;
        SimpleDateFormat formater = new SimpleDateFormat("yyyy");
        cal.add(Calendar.YEAR, nextVal);
        return "YEAR - "+formater.format(cal.getTime());
    }

    public String getCurrentWeekAndDate(int nextVal,boolean resetCalendar)
    {
        if(resetCalendar == true)
        {
            cal = Calendar.getInstance();
        }
        SimpleDateFormat formater = new SimpleDateFormat("dd MMM, yyyy");
        cal.add(Calendar.WEEK_OF_YEAR,nextVal);
        cal.set(Calendar.DAY_OF_WEEK, cal.getFirstDayOfWeek());
        String week = "Week "+ (cal.get(Calendar.WEEK_OF_YEAR))+"\n("+formater.format(cal.getTime());
        cal.add(Calendar.DATE, 6);
        week+=" - "+formater.format(cal.getTime())+")";
        cal.add(Calendar.DATE, -6);
        return week;
    }

    //INITIALIZE ALL UI ELEMENTS
    public void initMyUI() {
        txtCredit = (TextView) findViewById(R.id.textCredit);
        txtDebit = (TextView) findViewById(R.id.textDebit);
        txtCreditMin = (TextView) findViewById(R.id.textCreditMin);
        txtDebitMin = (TextView) findViewById(R.id.textDebitMin);
        txtDate = (TextView) findViewById(R.id.textDate);

        //Calendar View Options
        txtCalendar = (TextView) findViewById(R.id.textCalendar);
        txtDay = (TextView) findViewById(R.id.textDay);
        txtMonth = (TextView) findViewById(R.id.textMonth);
        txtWeek = (TextView) findViewById(R.id.textWeek);
        txtYear = (TextView) findViewById(R.id.textYear);

        btnBalanceLeft = (ImageView) findViewById(R.id.btnBalanceLeft);
        btnBalanceRight = (ImageView) findViewById(R.id.btnBalanceRight);
        btnBalanceMid = (TextView) findViewById(R.id.txtBalance);

        expenseDetailsTabClick = (TextView) findViewById(R.id.expenseDetailsTab);
        incomeDetailsTabClick = (TextView) findViewById(R.id.incomeDetailsTab);
        expenseDetailsTabClickSelector = (TextView) findViewById(R.id.expenseDetailsTabSelector);
        incomeDetailsTabClickSelector = (TextView) findViewById(R.id.incomeDetailsTabSelector);
        noDataErrs = (TextView) findViewById(R.id.noDataErr);

        final String [] spinnerArray = {"Category name","Amount of transaction","Date"};
        sortingSpinner = (Spinner) findViewById(R.id.spinnerSort);
        ArrayAdapter<String> spinnerArrayAdapter = new ArrayAdapter<String>(this, android.R.layout.simple_spinner_item, spinnerArray); //selected item will look like a spinner set from XML
        spinnerArrayAdapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
        sortingSpinner.setAdapter(spinnerArrayAdapter);
        sortingSpinner.setSelection(0);

        //Setting the background and text color of the selected calendar view
        //Storing the default value in shared preferences
        setCurrentCalendarView(DayView);

        nextData = (ImageView) findViewById(R.id.nextMonth);
        prevData = (ImageView) findViewById(R.id.prevMonth);
        connectorLeft = (ImageView) findViewById(R.id.connectorLeft);
        connectorRight = (ImageView) findViewById(R.id.connectorRight);

        cal= Calendar.getInstance();

        txtDate.setText(getCurrentDateAndTime(0,false));

        fontUtils = FontUtils.getInstance(mainActivityInstance);

        expenseDateLayout = (LinearLayout) findViewById(R.id.expenseDateLayout);
        expenseDateLayout.bringToFront();

        slidingBalanceLayout = (RelativeLayout) findViewById(R.id.layoutBalance);
        mainLayout = (RelativeLayout) findViewById(R.id.mainLayout);
        subLayout = (RelativeLayout) findViewById(R.id.subLayout);

        bottomLayout = (LinearLayout) findViewById(R.id.bottomLayout);
        bottomLayoutMin = (LinearLayout) findViewById(R.id.bottomLayoutMin);

        // Initially hide the content view.
        bottomLayoutMin.setVisibility(View.GONE);

        // Retrieve and cache the system's default "short" animation time.
        mShortAnimationDuration = getResources().getInteger(
                android.R.integer.config_shortAnimTime);

        mLayout = (SlidingUpPanelLayout) findViewById(R.id.sliding_layout);

        listOfBalance = (ExpandableListView) findViewById(R.id.slidingView);

         MMUtils.startAnimate(btnBalanceMid,R.anim.animateslider,mainActivityInstance);
      }

    //STORE THE TYPE OF CALENDAR VIEW IN SHARED PREFERENCES
    public void setCurrentCalendarView(String currentViewData)
    {
        String prevView = myPreference.getCurrentDateView();
        if(prevView != currentViewData) {
            if(prevView.equalsIgnoreCase(DayView) || prevView.equalsIgnoreCase("")) {
                setInActive(txtDay);
            }
            else
            if(prevView.equalsIgnoreCase(MonthView)) {
                setInActive(txtMonth);
            }
            else
            if(prevView.equalsIgnoreCase(YearView)) {
                setInActive(txtYear);
            }
            else
            if(prevView.equalsIgnoreCase(WeekView)) {
                setInActive(txtWeek);
            }
            else
            if(prevView.equalsIgnoreCase(DateView)) {
                setInActive(txtCalendar);
            }

            myPreference.setCurrentDateView(currentViewData);

            //For removing the default calendar view i.e. day , in case it is not removed due to slow execution issues
            if(isActive(txtDay)) {
                setInActive(txtDay);
            }

            if(currentViewData.equalsIgnoreCase(DayView)) {
                setActive(txtDay);
            }
            else
            if(currentViewData.equalsIgnoreCase(MonthView)) {
                setActive(txtMonth);
            }
            else
            if(currentViewData.equalsIgnoreCase(YearView)) {
                setActive(txtYear);
            }
            else
            if(currentViewData.equalsIgnoreCase(WeekView)) {
                setActive(txtWeek);
            }
            else
            if(currentViewData.equalsIgnoreCase(DateView)) {
                setActive(txtCalendar);
            }
        }
    }

    //SET THE VIEW ACTIVE BY CHANGING THE BACKGROUND AND TEXT COLOR
    public void setActive(TextView targetActive)
    {
        targetActive.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
        targetActive.setTextColor(getResources().getColor(R.color.White));
    }

    //CHECK THE VIEW IS ACTIVE OR NOT
    public boolean isActive(TextView targetCheck)
    {
        if(targetCheck.getCurrentTextColor() == getResources().getColor(R.color.White))
        {
            return true;
        }
        else
        {
            return false;
        }
    }

    //SET THE VIEW NON-ACTIVE BY CHANGING THE BACKGROUND AND TEXT COLOR
    public void setInActive(TextView targetInactive)
    {
        targetInactive.setBackgroundColor(getResources().getColor(R.color.colorAccent));
        targetInactive.setTextColor(getResources().getColor(R.color.Black));
    }

    //CHECK THE SELECTED DATE REACHED CURRENT DATE OR NOT
    public void hasNotReachedCurrentDate()
    {
        if(myPreference.getCurrentDateView().equalsIgnoreCase(DayView)) {
            SimpleDateFormat formatr = new SimpleDateFormat("ddMMyyyy");
            String formattedSelectedDate = formatr.format(cal.getTime()).toString();
            String formattedCurrentDate = formatr.format(Calendar.getInstance().getTime()).toString();
            if(Integer.parseInt(formattedSelectedDate.substring(2)) >= Integer.parseInt(formattedCurrentDate.substring(2))) {
                if(Integer.parseInt(formattedSelectedDate.substring(2)) == Integer.parseInt(formattedCurrentDate.substring(2))) {
                    if(Integer.parseInt(formattedSelectedDate.substring(0,2)) >= Integer.parseInt(formattedCurrentDate.substring(0,2))) {
                        blockNextButton();
                    }
                    else
                    {
                        unblockNextButton();
                    }
                }
                else
                {
                    blockNextButton();
                }
            }
            else {
                unblockNextButton();
            }
        }
        else
        if(myPreference.getCurrentDateView().equalsIgnoreCase(WeekView)) {
            if(cal.get(Calendar.WEEK_OF_YEAR) >= Calendar.getInstance().get(Calendar.WEEK_OF_YEAR)) {
                blockNextButton();
            }
            else {
                unblockNextButton();
            }
        }
        else
        if(myPreference.getCurrentDateView().equalsIgnoreCase(MonthView)) {
            if(cal.get(Calendar.MONTH) >= Calendar.getInstance().get(Calendar.MONTH)) {
                blockNextButton();
            }
            else {
                unblockNextButton();
            }
        }
        else
        if(myPreference.getCurrentDateView().equalsIgnoreCase(YearView)) {
            if(cal.get(Calendar.YEAR) >= Calendar.getInstance().get(Calendar.YEAR)) {
                blockNextButton();
            }
            else {
                unblockNextButton();
            }
        }
    }

    //BLOCKING AND UNBLOCKING NEXT BUTTON
    public void blockNextButton()
    {
        isNextBlocked = true;
        nextData.setImageResource(R.mipmap.nextblock);
    }

    public void unblockNextButton()
    {
        isNextBlocked = false;
        nextData.setImageResource(R.mipmap.next);
    }

    //INITIALIZE ALL PIE CHART ELEMENTS
    public void intiCharts() {
        mChart = (PieChart) findViewById(R.id.chart1);
        mChart.setUsePercentValues(false);
        mChart.getDescription().setEnabled(false);
        mChart.setExtraOffsets(5, 10, 5, 5);
        mChart.setDragDecelerationFrictionCoef(0.95f);
        mChart.setCenterTextTypeface(mTfLight);
        mChart.setCenterText(generateCenterSpannableText());
        mChart.setDrawHoleEnabled(true);
        mChart.setHoleColor(Color.WHITE);
        mChart.setTransparentCircleColor(Color.WHITE);
        mChart.setTransparentCircleAlpha(110);
        mChart.setHoleRadius(58f);
        mChart.setTransparentCircleRadius(61f);
        mChart.setDrawCenterText(true);
        mChart.setRotationAngle(0);

        // enable rotation of the chart by touch
        mChart.setRotationEnabled(true);
        mChart.setHighlightPerTapEnabled(true);

        // add a selection listener
        mChart.setOnChartValueSelectedListener(this);

        setData(4, 100);

        mChart.animateY(1400, Easing.EasingOption.EaseInCubic);
        mChart.getLegend().setEnabled(false);

        // entry label styling
        mChart.setEntryLabelColor(Color.BLACK);
        mChart.setEntryLabelTypeface(gothamMedium);
        mChart.setEntryLabelTextSize(12f);
    }

        //SET FONTS TO THE TEXT
    public void setFonts() {
        fontUtils.setFont(txtCredit, FontUtils.GothamHTF_Bold);
        fontUtils.setFont(txtDebit, FontUtils.GothamHTF_Bold);
        fontUtils.setFont(btnBalanceMid, FontUtils.GothamHTF_Medium);
        fontUtils.setFont(txtDate, FontUtils.GothamHTF_Medium);

        fontUtils.setFont(txtCalendar, FontUtils.GothamHTF_Light);
        fontUtils.setFont(txtDay, FontUtils.GothamHTF_Light);
        fontUtils.setFont(txtWeek, FontUtils.GothamHTF_Light);
        fontUtils.setFont(txtMonth, FontUtils.GothamHTF_Light);
        fontUtils.setFont(txtYear, FontUtils.GothamHTF_Light);
    }

    //SET ALL EVENTS ON THE ELEMENTS
    public void setMyEvents()
    {
        txtCredit.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                //if(isMenuVisibleOrNot==false) {
                    fragmentManager = getSupportFragmentManager();
                    fragmentTransaction = fragmentManager.beginTransaction();
                    myFragment = AddAccFragment.newInstance("Credit",cal);
                    fragmentTransaction.replace(R.id.subLayout,myFragment);
                    fragmentTransaction.commit();
                    mainLayout.setVisibility(View.GONE);
                    subLayout.setVisibility(View.VISIBLE);
                    mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
                    closeTheExpenseDateMenu();
                /*}
                else {
                    closeTheExpenseDateMenu();
                }*/
            }
        });

        txtCreditMin.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                //if(isMenuVisibleOrNot==false) {
                fragmentManager = getSupportFragmentManager();
                fragmentTransaction = fragmentManager.beginTransaction();
                myFragment = AddAccFragment.newInstance("Credit",cal);
                fragmentTransaction.replace(R.id.subLayout,myFragment);
                fragmentTransaction.commit();
                mainLayout.setVisibility(View.GONE);
                subLayout.setVisibility(View.VISIBLE);
                mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
                closeTheExpenseDateMenu();
                /*}
                else {
                    closeTheExpenseDateMenu();
                }*/
            }
        });

        txtDebit.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
               // if(isMenuVisibleOrNot==false) {
                    //Pass no of parameters accordingly
                    fragmentManager = getSupportFragmentManager();
                    fragmentTransaction = fragmentManager.beginTransaction();
                    myFragment = AddAccFragment.newInstance("Debit",cal);
                    fragmentTransaction.replace(R.id.subLayout,myFragment);
                    fragmentTransaction.commit();
                    mainLayout.setVisibility(View.GONE);
                    subLayout.setVisibility(View.VISIBLE);
                    mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
                    closeTheExpenseDateMenu();
                /* }
                else{
                    closeTheExpenseDateMenu();
                }*/

            }
        });

        txtDebitMin.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                // if(isMenuVisibleOrNot==false) {
                //Pass no of parameters accordingly
                fragmentManager = getSupportFragmentManager();
                fragmentTransaction = fragmentManager.beginTransaction();
                myFragment = AddAccFragment.newInstance("Debit",cal);
                fragmentTransaction.replace(R.id.subLayout,myFragment);
                fragmentTransaction.commit();
                mainLayout.setVisibility(View.GONE);
                subLayout.setVisibility(View.VISIBLE);
                mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
                closeTheExpenseDateMenu();
                /* }
                else{
                    closeTheExpenseDateMenu();
                }*/

            }
        });

        nextData.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(isMenuVisibleOrNot==false && isNextBlocked==false) {
                    mChart.spin(1000, mChart.getRotationAngle(), mChart.getRotationAngle() + 360, Easing.EasingOption
                            .EaseInCubic);
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(DayView) || myPreference.getCurrentDateView().equalsIgnoreCase(DayView)) {
                        txtDate.setText(getCurrentDateAndTime(1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(WeekView))
                    {
                        txtDate.setText(getCurrentWeekAndDate(1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(MonthView))
                    {
                        txtDate.setText(getCurrentMonth(1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(YearView))
                    {
                        txtDate.setText(getCurrentYear(1,false));
                        getDbDatas();
                    }
                    hasNotReachedCurrentDate();
                }
            }
        });

        prevData.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(isMenuVisibleOrNot==false) {
                    mChart.spin(1000, mChart.getRotationAngle(), mChart.getRotationAngle() - 360, Easing.EasingOption
                            .EaseInCubic);
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(DayView) || myPreference.getCurrentDateView().equalsIgnoreCase(DayView)) {
                        txtDate.setText(getCurrentDateAndTime( -1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(WeekView))
                    {
                        txtDate.setText(getCurrentWeekAndDate(-1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(MonthView))
                    {
                        txtDate.setText(getCurrentMonth(-1,false));
                        getDbDatas();
                    }
                    else
                    if(myPreference.getCurrentDateView().equalsIgnoreCase(YearView))
                    {
                        txtDate.setText(getCurrentYear(-1,false));
                        getDbDatas();
                    }
                    hasNotReachedCurrentDate();
                }
            }
        });

        txtCalendar.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                setActive(txtCalendar);
                closeTheExpenseDateMenu();

                //OPENING DATEPICKER
                DialogDatepickerFragment dialogDatepickerFragment = DialogDatepickerFragment.getInstance();
                dialogDatepickerFragment.show(getSupportFragmentManager(), "");
            }
        });

        txtYear.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                //BLOCKING THE EXECUTION IF THE VIEW IS ALREADY ACTIVE
                if(!(isActive(txtYear))) {
                    setCurrentCalendarView(YearView);
                    subLayout.setVisibility(View.GONE);
                    mainLayout.setVisibility(View.VISIBLE);
                    txtDate.setText(getCurrentYear(0,true));
                    hasNotReachedCurrentDate();
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    getDbDatas();
                }
                closeTheExpenseDateMenu();
            }
        });

        txtMonth.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(!(isActive(txtMonth))) {
                    setCurrentCalendarView(MonthView);
                    subLayout.setVisibility(View.GONE);
                    mainLayout.setVisibility(View.VISIBLE);
                    txtDate.setText(getCurrentMonth(0, true));
                    hasNotReachedCurrentDate();
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    getDbDatas();
                }
                closeTheExpenseDateMenu();
            }
        });

        txtWeek.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(!(isActive(txtWeek))) {
                    setCurrentCalendarView(WeekView);
                    subLayout.setVisibility(View.GONE);
                    mainLayout.setVisibility(View.VISIBLE);
                    txtDate.setText(getCurrentWeekAndDate(0, true));
                    hasNotReachedCurrentDate();
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    getDbDatas();
                }
                closeTheExpenseDateMenu();
            }
        });

        txtDay.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(!(isActive(txtDay))) {
                    setCurrentCalendarView(DayView);
                    subLayout.setVisibility(View.GONE);
                    mainLayout.setVisibility(View.VISIBLE);
                    txtDate.setText(getCurrentDateAndTime(0, true));
                    hasNotReachedCurrentDate();
                    MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorLeft,R.anim.dateanimate,mainActivityInstance);
                    MMUtils.startAnimate(connectorRight,R.anim.dateanimate,mainActivityInstance);
                    getDbDatas();
                }
                closeTheExpenseDateMenu();
            }
        });

        mLayout.addPanelSlideListener(new SlidingUpPanelLayout.PanelSlideListener() {
            @Override
            public void onPanelSlide(View panel, float slideOffset) {
                //Log.i(SLIDINGTAG, "onPanelSlide, offset " + slideOffset);
            }

            @Override
            public void onPanelStateChanged(View panel, SlidingUpPanelLayout.PanelState previousState, SlidingUpPanelLayout.PanelState newState) {
               // Log.i(SLIDINGTAG, "onPanelStateChanged " + newState);
                if(isMenuVisibleOrNot == true) {
                    closeTheExpenseDateMenu();
                }
                if(newState == SlidingUpPanelLayout.PanelState.EXPANDED) {

                   // Set the content view to 0% opacity but visible, so that it is visible
                    // (but fully transparent) during the animation.
                    bottomLayout.setAlpha(1f);
                    bottomLayoutMin.setAlpha(0f);
                    bottomLayoutMin.setVisibility(View.VISIBLE);
                    bottomLayoutMin.animate()
                            .alpha(1f)
                            .setDuration(mShortAnimationDuration)
                            .setListener(null);

                    bottomLayout.setVisibility(View.GONE);
                    bottomLayout.animate()
                            .alpha(0f)
                            .setDuration(mShortAnimationDuration);

                    MMUtils.startAnimate(btnBalanceMid,R.anim.animateslider,mainActivityInstance);
                 }
                else
                if(newState == SlidingUpPanelLayout.PanelState.COLLAPSED) {

                    bottomLayout.setAlpha(0f);
                    bottomLayout.setVisibility(View.VISIBLE);
                    bottomLayout.animate()
                            .alpha(1f)
                            .setDuration(mShortAnimationDuration)
                            .setListener(null);

                    bottomLayoutMin.animate()
                            .alpha(0f)
                            .setDuration(mShortAnimationDuration);
                    bottomLayoutMin.setVisibility(View.GONE);
                    }
            }
        });

        mLayout.setFadeOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
            }
        });

        listOfBalance.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                Toast.makeText(mainActivityInstance, "onItemClick", Toast.LENGTH_SHORT).show();
                closeTheExpenseDateMenu();
            }
        });

        expenseDetailsTabClick.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(currentDetailsView.equalsIgnoreCase("income")) {
                    currentDetailsView = "expense";
                    expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
                    incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
                    expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
                    incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
                    prepareListData();
                }
            }
        });

        incomeDetailsTabClick.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(currentDetailsView.equalsIgnoreCase("expense")) {
                    currentDetailsView = "income";
                    expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
                    incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
                    expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
                    incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
                    prepareListData();
                }
            }
        });

        listOfBalance.setOnTouchListener(new OnSwipeTouchListener(mainActivityInstance) {
             public void onSwipeRight() {
                if(currentDetailsView.equalsIgnoreCase("income")){
                    currentDetailsView = "expense";
                    expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
                    incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
                    expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
                    incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
                    prepareListData();
                }
            }
            public void onSwipeLeft() {
                if(currentDetailsView.equalsIgnoreCase("expense")){
                    currentDetailsView = "income";
                    expenseDetailsTabClick.setTextColor(getResources().getColor(R.color.LightSeaGreen));
                    incomeDetailsTabClick.setTextColor(getResources().getColor(R.color.White));
                    expenseDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.colorPrimaryDark));
                    incomeDetailsTabClickSelector.setBackgroundColor(getResources().getColor(R.color.White));
                    prepareListData();
                }
            }
        });

        sortingSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                if(mLayout.getPanelState() == SlidingUpPanelLayout.PanelState.EXPANDED){
                   currentSortingOption = position;
                }
                retrieveAccDatas(dataDateStart,dataDateEnd,currentSortingOption);
                prepareListData();
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {

            }
        });
    }

    // TO CLOSE THE UPPER EXPENSE DATE MENU
    public void closeTheExpenseDateMenu()
    {
        isMenuVisibleOrNot = false;
        if(closeMenuAnime == null)
        {closeMenuAnime = AnimationUtils.loadAnimation(getApplicationContext(), R.anim.moveup);}
        closeMenuAnime.setFillAfter(true);
        expenseDateLayout.startAnimation(closeMenuAnime);
        closeMenuAnime.setAnimationListener(new Animation.AnimationListener() {
            @Override
            public void onAnimationStart(Animation animation) {
            }

            @Override
            public void onAnimationEnd(Animation animation) {
                expenseDateLayout.setTop(400);
            }

            @Override
            public void onAnimationRepeat(Animation animation) {
            }
        });
        closeMenuAnime = null;
        expenseDateLayout.setVisibility(View.GONE);
    }

    //Datepicker date selected
    public void onChangeDatepickerDialogDate(int year, int monthOfYear, int dayOfMonth)
    {
        cal.set(Calendar.YEAR, year);
        cal.set(Calendar.MONTH, monthOfYear  );
        cal.set(Calendar.DAY_OF_MONTH, dayOfMonth);
        setCurrentCalendarView(DayView);
        subLayout.setVisibility(View.GONE);
        mainLayout.setVisibility(View.VISIBLE);
        txtDate.setText(getCurrentDateAndTime(0,false));
        MMUtils.startAnimate(txtDate,R.anim.dateanimate,mainActivityInstance);
        getDbDatas();
        //Checking for Next Button validation
        hasNotReachedCurrentDate();
    }

    @Override
    public void onBackPressed() {
        if(subLayout.getVisibility() == View.VISIBLE)
        {
            fragmentManager = getSupportFragmentManager();
            fragmentTransaction = fragmentManager.beginTransaction();
            AddAccFragment myFragment = new AddAccFragment();
            fragmentManager.popBackStack();
            fragmentTransaction.remove(myFragment);
            fragmentTransaction.commit();
            subLayout.setVisibility(View.GONE);
            mainLayout.setVisibility(View.VISIBLE);
            mainMenu.getItem(1).setVisible(false);
            mainMenu.getItem(0).setVisible(true);
            if(isMenuVisibleOrNot == true) {
                closeTheExpenseDateMenu();
            }
        }
        else
        if (mLayout != null &&
                (mLayout.getPanelState() == SlidingUpPanelLayout.PanelState.EXPANDED || mLayout.getPanelState() == SlidingUpPanelLayout.PanelState.ANCHORED)) {
            mLayout.setPanelState(SlidingUpPanelLayout.PanelState.COLLAPSED);
        } else
        if(isMenuVisibleOrNot == true) {
            closeTheExpenseDateMenu();
        }
        else {
            super.onBackPressed();
        }
    }

    @Override
    public void onDateSet(DatePicker view, int year, int monthOfYear,
                          int dayOfMonth) {
        // TODO Auto-generated method stub
        // Toast.makeText(mainActivityInstance, "date="+dayOfMonth+"/"+monthOfYear+"/"+year, Toast.LENGTH_SHORT).show();
        if(mainLayout.getVisibility() == View.VISIBLE) {
            onChangeDatepickerDialogDate(year,monthOfYear,dayOfMonth);
        }

    }

    @Override
    public void onFragmentInteraction(Uri uri) {

    }

    //GETTING ALL ACCOUNT DATAS AND STORING IN RESPECTIVE VARIABLES
    public void getDbDatas() {
        incomeAccDb = new IncomeAccountDBAdapter(this);
        incomeAccDb = incomeAccDb.open();

        expenseAccDb = new ExpenseAccountDBAdapter(this);
        expenseAccDb = expenseAccDb.open();

        if(catgAllDrawableHashmap.size()==0) {
            catgAllDrawableHashmap.put("Food", R.drawable.catg_food);
            catgAllDrawableHashmap.put("Travel", R.drawable.catg_transport);
            catgAllDrawableHashmap.put("Bill", R.drawable.catg_bill);
            catgAllDrawableHashmap.put("Car and bike", R.drawable.catg_carandbike);
            catgAllDrawableHashmap.put("Cloth", R.drawable.catg_clothes);
            catgAllDrawableHashmap.put("Eat Out", R.drawable.catg_eatout);
            catgAllDrawableHashmap.put("Phone", R.drawable.catg_phone);
            catgAllDrawableHashmap.put("Entertain", R.drawable.catg_entertainment);
            catgAllDrawableHashmap.put("Rent", R.drawable.catg_rental);
            catgAllDrawableHashmap.put("Gift", R.drawable.catg_gift);
            catgAllDrawableHashmap.put("Health", R.drawable.catg_health);
            catgAllDrawableHashmap.put("Pet", R.drawable.catg_pet);
            catgAllDrawableHashmap.put("Electronics", R.drawable.catg_electronics);
            catgAllDrawableHashmap.put("Sports", R.drawable.catg_sports);
            catgAllDrawableHashmap.put("Saving", R.drawable.catg_saving);
            catgAllDrawableHashmap.put("Income Tax", R.drawable.catg_tax);
            catgAllDrawableHashmap.put("Salary", R.drawable.catg_salary);
            catgAllDrawableHashmap.put("Home Rent", R.drawable.catg_homerent);
        }

        String currntView = myPreference.getCurrentDateView();

        amountIArray = new ArrayList<Integer>();
        dateOfTransIArray = new ArrayList<String>();
        shortNotesIArray = new ArrayList<String>();
        catgIArray = new ArrayList<String>();

        amountEArray = new ArrayList<Integer>();
        dateOfTransEArray = new ArrayList<String>();
        shortNotesEArray = new ArrayList<String>();
        paymentTypeEArray = new ArrayList<String>();
        catgEArray = new ArrayList<String>();

        catgChartArray = new ArrayList<String>();
        catgChartIArray = new ArrayList<String>();
        amountChartArray = new ArrayList<Integer>();

        SimpleDateFormat dateformater;
        String date,datelast;



        //FOR DIFFERENT TIME LIMITS
        switch (currntView){

            case "year":
                dateformater = new SimpleDateFormat("yyyy-MM-dd");
                date = dateformater.format(cal.getTime());
                date = date.substring(0,5)+"01-01";
                datelast = date.substring(0,5)+"12-31";
                //Toast.makeText(mainActivityInstance, ""+date+"--"+datelast, Toast.LENGTH_SHORT).show();
                retrieveAccDatas(date,datelast,currentSortingOption);
                break;

            case "week":
                dateformater = new SimpleDateFormat("yyyy-MM-dd");
                date = dateformater.format(cal.getTime());
                datelast = date.substring(0,date.length()-2)+(Integer.parseInt(date.substring(8))+6);
                //Toast.makeText(mainActivityInstance, ""+date+"--"+datelast, Toast.LENGTH_SHORT).show();
                retrieveAccDatas(date,datelast,currentSortingOption);
                break;

            case "month":
                dateformater = new SimpleDateFormat("yyyy-MM-dd");
                date = dateformater.format(cal.getTime());
                date=date.substring(0,(date.length()-2))+"01";
                datelast=date.substring(0,(date.length()-2))+String.valueOf(cal.getActualMaximum(Calendar.DAY_OF_MONTH));
                //Toast.makeText(mainActivityInstance, ""+date+"---"+datelast, Toast.LENGTH_SHORT).show();
                retrieveAccDatas(date,datelast,currentSortingOption);
            break;

            case "day":
                dateformater = new SimpleDateFormat("yyyy-MM-dd");
                date = dateformater.format(cal.getTime());
                //Toast.makeText(mainActivityInstance, ""+date+"---"+currntView+"---"+ cal.getActualMaximum(Calendar.DAY_OF_MONTH), Toast.LENGTH_SHORT).show();
                retrieveAccDatas(date,date,currentSortingOption);
            break;

            default:  //THIS ALWAYS GIVES DATAS FOR THE CURRENT DATE
                Toast.makeText(mainActivityInstance, "Something went wrong!", Toast.LENGTH_SHORT).show();
            break;
        }
        intiCharts();
    }

    public void retrieveAccDatas(String dateStart, String dateEnd, int sortOptionIndex){
        String [] tempIDatas, tempEDatas;
        dataDateStart = dateStart;
        dataDateEnd = dateEnd;

        if(sortOptionIndex==0) { // FOR CATEGORY SORTING
            expenseDataArray = expenseAccDb.getAccountDetails(dateStart,dateEnd);
            incomeDataArray = incomeAccDb.getAccountDetails(dateStart, dateEnd);
        }
        else if(sortOptionIndex==1){ //FOR AMOUNT SORTING
            expenseDataArray = expenseAccDb.getAccountDetailsSortByAmount(dateStart,dateEnd);
            incomeDataArray = incomeAccDb.getAccountDetailsSortByAmount(dateStart, dateEnd);
        }
        else if(sortOptionIndex==2){ //FOR DATE SORTING
            expenseDataArray = expenseAccDb.getAccountDetailsSortByDate(dateStart,dateEnd);
            incomeDataArray = incomeAccDb.getAccountDetailsSortByDate(dateStart, dateEnd);
        }
        if(expenseDataArray.size()>0)
        Log.d("check data=",expenseDataArray.get(0));
       // Toast.makeText(mainActivityInstance, ""+expenseDataArray.size(), Toast.LENGTH_SHORT).show();
        if(incomeDataArray.size()>0) {
            amountIArray.clear();
            totalIncome = 0;
            dateOfTransIArray.clear();
            shortNotesIArray.clear();
            catgIArray.clear();
            for(int x=0;x<incomeDataArray.size();x++){
                tempIDatas = (incomeDataArray.get(x)).split("-#-");
                amountIArray.add(x,Integer.parseInt(tempIDatas[0]));
                totalIncome+=amountIArray.get(x);
                dateOfTransIArray.add(x,tempIDatas[1]);
                shortNotesIArray.add(x,tempIDatas[2]);
                catgIArray.add(x,tempIDatas[3]);
            }
        }

        if(expenseDataArray.size()>0){
            amountEArray.clear();
            totalExpense = 0;
            dateOfTransEArray.clear();
            shortNotesEArray.clear();
            catgEArray.clear();
            for(int x=0;x<expenseDataArray.size();x++){
                tempEDatas = expenseDataArray.get(x).split("-#-");
               amountEArray.add(x,Integer.parseInt(tempEDatas[0]));
                totalExpense+=amountEArray.get(x);
                dateOfTransEArray.add(x,tempEDatas[1]);
                shortNotesEArray.add(x,tempEDatas[2]);
                paymentTypeEArray.add(x,tempEDatas[3]);
                catgEArray.add(x, tempEDatas[4]);
            }
        }
        //Toast.makeText(mainActivityInstance, "catg e"+(catgEArray.size()), Toast.LENGTH_SHORT).show();
    }

    /*
	 * Preparing the list data
	 */
    private void prepareListData() {
         if(currentDetailsView.equalsIgnoreCase("expense")){
            listDataHeader = catgChartArray;
        }
        else{
            int tempIndex;
            if(amountIArray.size()>0){
                catgChartIArray.clear();
                for (int i = 0; i < amountIArray.size() ; i++) {
                    tempIndex =catgChartIArray.indexOf(catgIArray.get(i));
                    if(tempIndex>=0){}
                    else{
                         catgChartIArray.add(catgIArray.get(i));
                    }
                }
            }
            listDataHeader = catgChartIArray;
        }
        listDataChild = new HashMap<String, List<String>>();

        if(listDataHeader.size()==0){
           if(currentDetailsView.equalsIgnoreCase("expense")){
                noDataErrs.setText("To add expense details, tap at\n [ Add Expense ] at the bottom of your screen.");
            }
            else {
                noDataErrs.setText("To add income details, tap at\n [ Add Income ] at the bottom of your screen");
            }
            noDataErrs.setVisibility(View.VISIBLE);
        }
        else{
            noDataErrs.setVisibility(View.GONE);
        }

        if(currentDetailsView.equalsIgnoreCase("expense")){
            for(int x=0;x<listDataHeader.size();x++){
                List<String> txtChildData = new ArrayList<String>();
                for(int y = 0;y<catgEArray.size();y++){
                      if(catgEArray.get(y).equalsIgnoreCase(listDataHeader.get(x))){
                           txtChildData.add(String.valueOf(dateOfTransEArray.get(y)+"-@-"+amountEArray.get(y)+"-@-"+paymentTypeEArray.get(y)+"-@-"+shortNotesEArray.get(y)));
                      }
                }
                listDataChild.put(listDataHeader.get(x), txtChildData);
                //Toast.makeText(mainActivityInstance, ""+listDataChild.get(listDataHeader.get(x)), Toast.LENGTH_SHORT).show();
            }
        }
        else{
            for(int x=0;x<listDataHeader.size();x++){
                List<String> txtChildData = new ArrayList<String>();
                for(int y = 0;y<catgIArray.size();y++){
                    if(catgIArray.get(y).equalsIgnoreCase(listDataHeader.get(x))){
                        txtChildData.add(String.valueOf(dateOfTransIArray.get(y)+"-@-"+amountIArray.get(y)+"-@-"+""+"-@-"+shortNotesIArray.get(y)));
                    }
                }
                listDataChild.put(listDataHeader.get(x), txtChildData);
            }
        }

            listAdapter = new ListViewCustomAdapter(this, listDataHeader, listDataChild);
            // setting list adapter
            listOfBalance.setAdapter(listAdapter);

           //CHECKING AND OPENING THE RESPECTIVE CATEGORY DATA IN ACCOUNT DATAS
            if (chartClickedCatgIndex >= 0 && catgEArray.size()>0 && currentDetailsView.equalsIgnoreCase("expense")) {
                listOfBalance.expandGroup(chartClickedCatgIndex, true);
            }
    }
}
